MongoDB Sharding Overview
=================

#### 参考URL
[MongoDBでゆるふわDB体験 第5回「MongoDBのシャーディングを試してみよう」](http://gihyo.jp/dev/serial/01/mongodb/0005)

----
# シャーディングのメリット
シャーディングとは、データを複数のサーバに分散（水平スケーリング）させる機能で、以下のようなメリットがあります。

### 負荷分散による性能の向上

データを複数のサーバに分散させることにより、CPUやI/O負荷を分散させることが可能です。

### リソース分散によるコストパフォーマンスの向上

近年、メモリやディスクの価格は大変安くなってきましたが、サイズの大きなモジュールほど価格が高く、また価格の上昇幅が大きくなることは変わりません。

----
# MongoDBにおけるシャーディング方式

MongoDBは、NoSQLデータベースでよく採用されている Consistent Hashing ではなく、RDBMSではおなじみのレンジパーティションを採用しています。
シャードキーを指定することで、各サーバに格納されるデータの範囲が決定されます。サーバ間で重複データは持たず、1つのデータが格納されるサーバはシャードキーの範囲によって1つに決定されます。

### 概要図
[MongoDBでゆるふわDB体験 第5回「MongoDBのシャーディングを試してみよう」より 引用](http://gihyo.jp/dev/serial/01/mongodb/0005)

![overview](http://image.gihyo.co.jp/assets/images/dev/serial/01/mongodb/0005/thumb/TH400_001.jpg)

キー範囲の調整と、調整に伴うサーバ間のデータの移動まで全部MongoDBが行う自動バランシングという機能もあります。自動バランシングにより、サーバ間のデータの偏りをユーザが意識しなくてもよいように設計されています。また、新たにサーバを追加した場合も、同様にデータの移動を行い偏りがなくなるように自動調整します。

----
# キーワード

### シャード(mongod)

> 実際にデータが格納されているmongodプロセスです。1つのドキュメントは1つのシャードに格納され、シャード間でデータの複製は行いません。必須ではありませんがレプリケーション構成とすることを推奨されています。

### mongosサーバ

> シャーディングにおけるルーティングプロセスです。シャードとクライアントを連携させます。必要があれば複数のmongosサーバをたてることが可能です。mongodプロセスではないので、状態やデータを持っていません。

### configサーバ

> シャーディングのメタデータを管理しているmongodプロセスです。単一障害点となるので、複数のconfigサーバで構成することが推奨されています。

### シャードキー

> データを分散する範囲のキーです。複数指定もできます。キー上のどの範囲のデータがどのシャードに格納されるかは、MongoDBが管理し、データの偏りによって自動調整を行います。シャーディングにおいて、シャードキーの設計が非常に重要になります。

<pre>
例
//uidをShardキーに指定
db.runCommand( { shardcollection : "{collection_name}" , key : { uid : 1 } } );

//2つのフィールドも指定できる
db.runCommand( { shardcollection : "{collection_name}" , key : { lastname : 1, firstname : 1 } } );
</pre>

### チャンク

> シャーディングにおけるチャンクとは、分散するデータの単位です。具体的には、あるコレクションの連続した範囲のデータで、複数のドキュメントとなります。チャンクの最大サイズ（標準で200MB）に達すると分割され、シャードが持っているチャンク数に応じて必要ならば他のシャードに移動されます。チャンクの最大サイズは変更可能です。

----
それでは実際にシャーディングを設定してみましょう。[step01](https://github.com/syokenz/marunouchi-mongodb/tree/master/20130925/a-hayashida/step01)へ進んでください。
