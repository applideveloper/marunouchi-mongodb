MongoDB Sharding Overview
=================

----
# シャーディングのメリット
シャーディングとは、データを複数のサーバに分散（水平スケーリング）させる機能で、以下のようなメリットがあります。

### 負荷分散による性能の向上

データを複数のサーバに分散させることにより、CPUやI/O負荷を分散させることが可能です。

### リソース分散によるコストパフォーマンスの向上

近年、メモリやディスクの価格は大変安くなってきましたが、サイズの大きなモジュールほど価格が高く、また価格の上昇幅が大きくなることは変わりません。

----
# MongoDBにおけるシャーディング方式

MongoDBは、NoSQLデータベースでよく採用されている Consistent Hashing ではなく、RDBMSではおなじみのレンジパーティションを採用しています。
シャードキーを指定することで、各サーバに格納されるデータの範囲が決定されます。サーバ間で重複データは持たず、1つのデータが格納されるサーバはシャードキーの範囲によって1つに決定されます。

### 概要図
[MongoDBでゆるふわDB体験 第5回「MongoDBのシャーディングを試してみよう」より 引用](http://gihyo.jp/dev/serial/01/mongodb/0005)

![overview](http://image.gihyo.co.jp/assets/images/dev/serial/01/mongodb/0005/thumb/TH400_001.jpg)

キー範囲の調整と、調整に伴うサーバ間のデータの移動まで全部MongoDBが行う自動バランシングという機能もあります。自動バランシングにより、サーバ間のデータの偏りをユーザが意識しなくてもよいように設計されています。また、新たにサーバを追加した場合も、同様にデータの移動を行い偏りがなくなるように自動調整します。

----
# 登場人物

### mongod(shards)

> 実際にデータが格納されているmongodプロセスです。1つのドキュメントは1つのシャードに格納され，シャード間でデータの複製は行いません。必須ではありませんがレプリケーション構成とすることを推奨されています。

### mongos

> ルーティングプロセス。単一のサーバであるかのように、シャードされたデータベースとクライアントを連携させる。必要があれば複数のmongosサーバをたてることができる。それらは状態を共有しない。DBプロセスではないので、dbpathの指定は不要。

### config servers

> 各構成サーバは、システムにどんなシャードが存在しているかといったような、クラスタのメタデータを含んでいる。保護のために複数の構成サーバがあり、１つがダウンしたら、構成サーバは読み取り専用モードになる。ただし、シャードは読み書きモードで動作し続ける。


----
# 用語集
[Shardingの紹介 MongoDB公式マニュアルより 引用](http://www.mongodb.org/pages/viewpage.action?pageId=5537937)

### Shard

> それぞれのshardは1つ以上のサーバで構成され、mongodプロセス (mongodはMongoDBのデータベースプロセスのコアです) を使いデータを保存します。プロダクション環境においては、可用性を高め、自動フェイルオーバー機能を有効にするために1つのshardに対し複数のサーバを用意しそこにReplicationを構築します。この複数のサーバ/mongodプロセスのセットは、 replica set から成ります。

### Replica sets

> 各ノードメンバーに対してフェイルオーバーやリカバリーの機能を自動で提供します。1-7台までをサポートします。

[Replica Set Configuration - MongoDB公式マニュアル](http://www.mongodb.org/display/DOCSJP/Replica+Set+Configuration)

### Shardキー

> コレクションを分割するために必要な設定です。1つかまたは2つ以上のフィールドを設定します。後から変更できないので、とても重要です。Shardキーの値を持たないドキュメントは保存できません。ただしnullは可能です。

<pre>
例
//uidをShardキーに指定
db.runCommand( { shardcollection : "{collection_name}" , key : { uid : 1 } } );

//2つのフィールドも指定できる
db.runCommand( { shardcollection : "{collection_name}" , key : { lastname : 1, firstname : 1 } } );
</pre>

### Chunk

> chunkは、特定のコレクションの連続した範囲のデータ(ドキュメント)です。（コレクション, 最小キー, 最大キー）の組み合わせでchunkを表現できます。shardキーが K のドキュメントは、「最小キー」<= K < 「最大キー」と言う条件のchunkにマッチします。
chunkは、最大サイズ（標準で200MB）に達すると、そのchunkは2つの新しいchunkに 分割 されます。あるshardが余剰データを持っている場合、chunkがシステムによって他のshardに移動されます。同様に、サーバ(shard)を追加したときchunkは移動します。


<pre>
例
ChunkA [ "a", "k" )
ChunkB [ "k", "{" ) 
//例えばChunkAは [ "a", "k" ), ChunkBが [ "k", "{" ) のレンジを持っていたとすると、
//ShardKeyのイニシャルが"a"から"j"までの値を持つドキュメントはChunkAに、
//"k"から"z"までを持つドキュメントはChunkBに属します。"{" は "z" の次の順序を持つ値です。
//http://doryokujin.hatenablog.jp/entry/20110601/1306858487
//レンジは自動で設定され、手動での設定はできないようです。ただし、chunkの手動移動は可能です。
//また、2.2からタグによるレンジ指定が可能になるようです。
</pre>

----
それでは実際にシャーディングを設定してみましょう。[step01](https://github.com/syokenz/marunouchi-mongodb/tree/master/20130925/a-hayashida/step01)へ進んでください。
