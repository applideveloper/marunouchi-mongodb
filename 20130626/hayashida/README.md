MongoDB レプリケーション(Replica Sets)
=================

概要
=================

[公式ＨＰ](http://docs.mongodb.org/manual/core/replication-introduction/)

レプリケーションは、多数のサーバ間でデータを同期させる仕組みです。
MongoDBでは、一つのサーバ（プライマリ/マスタ）だけが書き込み要求を処理します（これは一貫性を保つためです）。また、プライマリノードは、「eventual consistency」が保たれるときだけ、読み込み要求をセカンダリノードへ転送します。



![image](http://www.infoq.com/resource/articles/mongodb-java-php-python/en/resources/replicaSetSimple.png)

レプリカセットは非同期型マスタ／スレーブ構成のレプリケーションをします。また、自動的にフェールオーバとリリカバーできます。
レプリカセットは２つ以上のコピーからなります。
レプリカセットは自動的にプライマリノードを選出しますが。ただ、shared-nothingのアーキテクチャに基づいているため、本質的にマスターというものは存在しません（構成的にはどれも同じ）。
ドライバ(mongosも同様)は自動的にプライマリノードが変わったことを検知し、新しいプライマリノードに更新をかけるようにします（mongos sharding プロセスも同様）。




* レプリケーションの目的
（[MongoDBでゆるふわDB体験](http://gihyo.jp/dev/serial/01/mongodb/0004)より一部引用）

** 可用性の向上

マスターノードがスレーブノードと同期していることから、マスターノードに障害が起きてもデータロストやサービス停止時間を最小限にすることが可能です。また近年ではDR（ディザスタリカバリ）対応のため、地理的に離れたデータセンターにノードを分散させる設計も多く見られます。

** 保守性の向上

レプリケーションは負荷の高い操作をスレーブノードで実行できることにより、メンテナンス性を高めてくれます。たとえばバックアップをスレーブノードで行い、不要な負荷をマスターノードにかけないようにすることは広く行われています。

** 負荷分散による性能の向上

レプリケーションを使用すれば、読み取り（Read）の負荷をノード間で分散させることができます。負荷のほとんどがReadで占められているようなアプリケーションの場合、Readの負荷をスレーブに分散させることによりシステムをスケールさせることが可能です。MongoDBではv2.2から、Readノードの分散をドライバで実装可能となりました。データの読み取り一貫性レベルに応じて、どのノードからReadするかをアプリケーションから容易に設定することが可能です。




* 障害復旧

レプリカセットの最小構成は以下のとおり

* 2つの「full node」と1つの「arbiter」
* 3つの「full node」

※）arbiterはマスターの選出だけに参加するノードで、データは保持していません。

単一障害点を回避するために、これらのノードは別のコンピュータにすべきです。
基本的には、少なくともプライマリになるれるノードを２台用意します。


